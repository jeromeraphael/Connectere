<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Dash</title>
    <style>
        .center {
            margin: auto; 
            display: table; 
        }

        .col-2 {
            width: 50%; 
        }

        body {
            width: 100%; 
            height: 100%; 
            margin: 0; 
            box-sizing: border-box;
        }

        input, form {
            width: 95%; 
        }

        .relationshipDiv {
            /* display: inline-grid;  */
            border: 2px solid black; 
            border-radius: 10px; 
            margin-left: 2.5vw; 
            margin-right: 2.5vw; 
            margin-top: 1.5vh; 
            margin-bottom: 1.5vh;  
            padding-left: 2vw; 
            padding-right: 2vw; 
            padding-top: 2vh; 
            padding-bottom: 2vh; 
            width: auto; 
            max-width: 45vw;  
        }

        #dash-grid {
            display: inline-grid; 
            grid-template-columns: 45vw 45vw; 
        }

        #body-wrapper {
            margin-left: 1.5vw; 
            margin-right: 1.5vw; 
            margin-top: 1.5vh; 
            margin-bottom: 1.5vh; 
            width: 97vw; 
            height: 100%; 
        }


        .chat, .relationshipInfo {
            display: inline; 
        }

        .relationshipInfo {
            float: left;
        }

        .chat {
            float: right;
            height: inherit; 
            max-height: 40vh; 
            overflow-y: auto;  
        }

        h5 {
            margin: 0; 
        }

        .chatHeader {
            background-color: black; 
            color: white; 
            margin: 0; 
            padding: 0.75em;
            padding-right: 0;  
            width: auto; 
            margin-bottom: 1vh; 
        }

        .chatHeader:hover {
            cursor: pointer; 
        }

        .chatDisplayBox {
            display: none; 
        }

        .chatDisplayBox.show {
            display: table;  
        }

    </style>
</head>
<body>
    <div id="body-wrapper" class='center'>
        <div id="nav"></div>
        <div id="header">
            <h1>Ongoing Relationships</h1>
        </div>
        <div id="dash-grid" class="center">
        </div>
    </div>
    <script>
        var userId = 3; 
        var userType = 'mentee'; 
        
        const getRelationships = (userId) => {
            fetch(`/${userId}/ongoingRelationships`, {
                method: "GET", 
                credentials: 'same-origin', 
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(relationships => relationships.json())
            .then(relationships => {
                console.log(relationships)
                relationships.forEach(relationship => {
                    let id  = relationship['relationshipId']; 
                    let startDate = new Date(relationship['dateBegan'].slice(0, 10)); 
                    let today = new Date()
                    let dateDiff = today.getDate() - startDate.getDate(); 
                    let relationshipGridDiv = `
                    <div id="relationship${id}" class='relationshipDiv'>
                        <div class='relationshipInfo col-2'>
                            <h5 class='relationshipHeader'>${userType !== 'mentor' ? "Mentor: ": "Mentee: "}${userType !== 'mentor' ? relationship['mentorName']: relationship['menteeName']}</h5>
                            <p id = "status-relationship${id}" class='lifeCycleStatus'>${relationship['lifeCycleStatus']}</p>
                            <p class='dateBegan'>Relationship began ${dateDiff} days ago</p>
                        </div>
                        <div class="chat col-2">
                            <p class="chatHeader">Chat + </p>
                            <div class="chatDisplayBox">
                                <div class="chatHistory">
                                    <form action="submit" id="msg-form${id}" class='msg-form' autocomplete="off">
                                        <input type="text" id="input-relationship${id}" placeholder="Send Chat Message">
                                    </form>
                                </div>
                            </div>
                    </div>`; 
                    document.getElementById("dash-grid").insertAdjacentHTML('afterbegin', relationshipGridDiv); 

                    //-----------------------------------------------------------------------------------------
                    if (relationship['DAYOFMONTH(NOW())'] == relationship['DAYOFMONTH(dateBegan)'] && relationship['MONTH(NOW())'] != relationship['MONTH(dateBegan)']){
                        if (userType === 'mentee'){
                            let answer = confirm(`Your relationship with ${relationship['mentorName']} is one month old. Do you wish to extend it?`)
                            console.log(answer)
                            if(! answer){   
                                document.getElementById(`input-relationship${id}`).disabled = true;
                                document.getElementById(`status-relationship${id}`).innerHTML = 'Terminated';
                                fetch('/updateRelationship', {
                                    headers: {"Content-Type": "application/json"},
                                    method: "POST",
                                    body: JSON.stringify({
                                        "relationshipId": relationship['relationshipId']
                                    })
                                }).then(response => response.json())
                            }
                        }
                        else{
                            let answer = confirm(`Your relationship with ${relationship['menteeName']} is one month old. Do you wish to extend it?`);
                            console.log(answer)
                            if(! answer){   
                                document.getElementById(`input-relationship${id}`).disabled = true;
                                document.getElementById(`status-relationship${id}`).innerHTML = 'Terminated';
                                fetch('/updateRelationship', {
                                    headers: {"Content-Type": "application/json"},
                                    method: "POST",
                                    body: JSON.stringify({
                                        "relationshipId": relationship['relationshipId']
                                    })
                                }).then(response => response.json())
                            }
                        }

                    }

                    //------------------------------------------------------------------------------------------
                    let form  = document.getElementById(`msg-form${id}`); 
                    let input = document.getElementById(`input-relationship${id}`);
                    let chatHeader = document.querySelector(`#relationship${id}>.chat>.chatHeader`);
                    let chatHistory = document.querySelector(`#relationship${id}>.chat>.chatDisplayBox`); 

                    form.addEventListener('submit', e => {
                        e.preventDefault(); 
                        if (input.value) {
                            sendChat(id, userId, input.value);  
                        }
                    });

                    chatHeader.addEventListener('click', () => {
                        if (chatHistory.classList.length === 2) {
                            chatHistory.classList.remove('show'); 
                            chatHeader.innerHTML = "Chat + "; 
                        }
                        else {
                            chatHistory.classList.add('show'); 
                            chatHeader.innerHTML = "Chat -"
                        }
                    }); 
                    getChatHistory(id); 

                }) 
            }); 
        }
        
        const getChat = async (userId) => {
            console.log(pass); 
        }

        const getUserData = (userId) => {
            fetch(`users/${userId}`, {
                credentials: 'same-origin', 
                header: {
                    'Content-Type': 'application/json'
                }
            })
            .then(userData => userData.json())
            .then(userData => localStorage.setItem("userData", JSON.stringify(userData))); 
        }

        getUserData(userId); 
        let userName = JSON.parse(localStorage.getItem('userData'))[0]["Full Name"];
        console.log(userName); 

        const addNewChatMessage = (senderId, newMessage, relationship) => {
            let relationshipChatDisplay = document.querySelector(`#${relationship}>.chat>.chatDisplayBox`); 
            let messageDiv = document.createElement('div');
            let message = document.createElement('span');
            let sender = document.createElement('span'); 
            sender.className = 'mesage-sender'; 
            sender.textContent = `${senderId}: ` 
            messageDiv.appendChild(sender);
            message.textContent = newMessage; 
            message.clasName = 'message-content'; 
            messageDiv.appendChild(message); 
            relationshipChatDisplay.prepend(messageDiv); 
            document.querySelector(`#input-${relationship}`).value = '';
        }

        const getChatHistory = (relationship) => {
            fetch(`/${relationship}/chats`, {
                    credentials: 'same-origin', 
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(chats => chats.json())
                .then(chats => {
                    for (let i = 0; i < chats.length; i++) {                        
                        addNewChatMessage(chats[i]['Sender'], chats[i]['chatContent'], `relationship${relationship}`); 
                    }
                }); 
        }

        const sendChat = (relationshipId, userId, message) => {
            console.log(relationshipId + ' ' + userId + ' ' + message);
            fetch('/save-chat', {
                headers: { 
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin', 
                method: "POST", 
                body: JSON.stringify({
                    'relationshipId': relationshipId, 
                    'userId': userId, 
                    'message': message
                })
            })
            .then(addNewChatMessage(userName, message, `relationship${relationshipId}`));
        }

        getRelationships(userId); 

    </script>
</body>
</html>